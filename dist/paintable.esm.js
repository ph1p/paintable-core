function t(t,i,s,e){return new(s||(s=Promise))((function(n,h){function o(t){try{a(e.next(t))}catch(t){h(t)}}function r(t){try{a(e.throw(t))}catch(t){h(t)}}function a(t){var i;t.done?n(t.value):(i=t.value,i instanceof s?i:new s((function(t){t(i)}))).then(o,r)}a((e=e.apply(t,i||[])).next())}))}class i{constructor(){this.name="paintable",this.color="#000000",this.lineWidth=5,this.threshold=0,this.isMouse=!0,this.currentX=0,this.currentY=0,this.factor=1,this.canvasIsEmpty=!1,this.canvasId=Math.round(1e3*Math.random()),this.isEraserActive=!1,this.isActive=!1,this.canvas=null,this.ctx=null,this.startedDrawing=!1,this.thresholdReached=!1,this.pointCoords=[],this.redoList=[],this.registry=[],this.moveEvent=this.drawMove.bind(this),this.startEvent=this.drawStart.bind(this),this.endEvent=this.drawEnd.bind(this),this.reInit()}reInit(){this.clear(!1,!0),this.isActive=!1;try{this.pointCoords=[],this.load()}catch(t){}}setCanvas(t,i=!0){this.canvas=t,this.ctx=t.getContext("2d"),i&&this.registerEvents(),this.reInit()}setName(t){this.name=t,this.reInit()}setColor(t){this.color=t,this.ctx&&(this.ctx.strokeStyle=t)}setActive(t){this.isActive=t}setThreshold(t){this.threshold=t}setLineWidth(t){this.lineWidth=t,this.ctx&&(this.ctx.lineWidth=t)}setLineWidthEraser(t){this.lineWidth=t}serialize(t){return t.elements=t.elements.map((t=>{var i;return"line"===t.type?Object.assign(Object.assign({},t),{points:null===(i=t.points)||void 0===i?void 0:i.reduce(((t,i)=>[...t,i.x,i.y]),[])}):t})),JSON.stringify(t)}deserialize(t){const i=JSON.parse(t);return i.elements=i.elements.map((t=>{var i,s,e;if("line"===t.type){let n;if(null==t?void 0:t.points){n=[];for(let h=0;h<(null===(i=null==t?void 0:t.points)||void 0===i?void 0:i.length);h+=2)n.push({x:null===(s=null==t?void 0:t.points)||void 0===s?void 0:s[h],y:null===(e=null==t?void 0:t.points)||void 0===e?void 0:e[h+1]})}return Object.assign(Object.assign({},t),{points:n})}return t})),i}setItem(t,i){localStorage.setItem(t,this.serialize(i))}getItem(i){return t(this,void 0,void 0,(function*(){return new Promise(((t,s)=>{const e=this.deserialize(localStorage.getItem(i)||"");e?t(e):s()}))}))}removeItem(t){localStorage.removeItem(t)}get scalingFactor(){return window.devicePixelRatio||1}get isTouch(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}cancel(){this.isActive&&(this.clear(),this.load(),this.isActive=!1)}registerEvents(){this.canvas&&(this.canvas.removeEventListener("mousemove",this.moveEvent),this.canvas.removeEventListener("mousedown",this.startEvent),this.canvas.removeEventListener("mouseup",this.endEvent),this.canvas.removeEventListener("touchmove",this.moveEvent),this.canvas.removeEventListener("touchstart",this.startEvent),this.canvas.removeEventListener("touchend",this.endEvent),this.isMouse?(this.canvas.addEventListener("mousemove",this.moveEvent),this.canvas.addEventListener("mousedown",this.startEvent),this.canvas.addEventListener("mouseup",this.endEvent)):(this.canvas.addEventListener("touchmove",this.moveEvent),this.canvas.addEventListener("touchstart",this.startEvent),this.canvas.addEventListener("touchend",this.endEvent)))}undo(){this.registry.length>0&&this.isActive&&(this.redoList.push(this.registry[this.registry.length-1]),this.registry.pop(),this.ctx&&(this.ctx.globalCompositeOperation="source-over"),this.drawEntriesFromRegistry())}redo(){this.undoRedoCanvasState(this.redoList,this.registry)}undoRedoCanvasState(t,i){t.length>0&&this.isActive&&(i.push(t[t.length-1]),t.pop(),this.ctx&&(this.ctx.globalCompositeOperation="source-over"),this.drawEntriesFromRegistry())}drawEntriesFromRegistry(){this.clearCanvas(),this.registry.forEach((t=>{"line"===t.type?this.drawLine(t):"clear"===t.type&&this.clearCanvas()}))}clearCanvas(){var t;this.canvas&&this.isActive&&(null===(t=this.ctx)||void 0===t||t.clearRect(0,0,this.canvas.width,this.canvas.height))}clear(t=!1,i=!1){(this.isActive||i)&&(this.clearCanvas(),t?this.registry.push({type:"clear"}):(this.registry=[],this.redoList=[]))}isCanvasBlank(){this.ctx&&(this.ctx.globalCompositeOperation="source-over");const t=document.createElement("canvas"),i=t.getContext("2d");return!this.canvas||(null==i||i.clearRect(0,0,this.canvas.width,this.canvas.height),t.width=this.canvas.width,t.height=this.canvas.height,t.toDataURL()===this.canvas.toDataURL())}load(){return t(this,void 0,void 0,(function*(){try{this.clearCanvas();const t=yield this.getItem(this.name);this.registry=t.elements||[],this.drawEntriesFromRegistry(),this.canvasIsEmpty=this.isCanvasBlank()}catch(t){}}))}save(){var t,i;this.isActive&&(this.isEraserActive=!1,this.isCanvasBlank()?this.removeItem(this.name):this.setItem(this.name,{width:null===(t=this.canvas)||void 0===t?void 0:t.width,height:null===(i=this.canvas)||void 0===i?void 0:i.height,elements:this.registry}),this.redoList=[],this.canvasIsEmpty=this.isCanvasBlank())}drawStart(t){if(t.preventDefault(),this.thresholdReached=!1,this.isActive&&this.canvas){this.drawEntriesFromRegistry(),this.redoList=[],this.startedDrawing=!0;const i=this.isMouse?t.clientX:t.targetTouches[0].clientX,s=this.isMouse?t.clientY:t.targetTouches[0].clientY;i&&s&&(this.currentX=(i-this.canvas.getBoundingClientRect().left)*this.factor,this.currentY=(s-this.canvas.getBoundingClientRect().top)*this.factor,this.pointCoords.push({x:this.currentX,y:this.currentY})),this.ctx&&(this.ctx.globalCompositeOperation=this.isEraserActive?"destination-out":"source-over")}}drawEnd(){if(this.isActive&&this.canvas){const t=this.pointCoords.filter(((t,i)=>0===i||i%4==0||i===this.pointCoords.length-1));this.registry.push({width:this.lineWidth,color:this.color,type:"line",points:t}),this.drawEntriesFromRegistry(),this.startedDrawing=!1,this.pointCoords=[],this.thresholdReached=!1}}drawLine(t){var i,s,e,n;if(t&&this.ctx&&(this.ctx.lineCap="round",this.ctx.lineWidth=t.width||this.lineWidth,this.ctx.strokeStyle=t.color||this.color),t.points&&t.points.length>0){null===(i=this.ctx)||void 0===i||i.beginPath(),null===(s=this.ctx)||void 0===s||s.moveTo(t.points[0].x,t.points[0].y);for(let i=0;i<t.points.length-1;i++){const s=i>0?t.points[i-1]:t.points[0],n=t.points[i],h=t.points[i+1],o=i!=(t.points||[]).length-2?t.points[i+2]:h,r=n.x+(h.x-s.x)/6,a=n.y+(h.y-s.y)/6,c=h.x-(o.x-n.x)/6,v=h.y-(o.y-n.y)/6;null===(e=this.ctx)||void 0===e||e.bezierCurveTo(r,a,c,v,h.x,h.y)}null===(n=this.ctx)||void 0===n||n.stroke()}}drawMove(t){if(t.preventDefault(),this.isActive&&this.startedDrawing&&this.canvas){const i=this.isMouse?t.clientX:t.targetTouches[0].clientX,s=this.isMouse?t.clientY:t.targetTouches[0].clientY;if(i&&s){if(this.currentX=(i-this.canvas.getBoundingClientRect().left)*this.factor,this.currentY=(s-this.canvas.getBoundingClientRect().top)*this.factor,this.pointCoords.push({x:this.currentX,y:this.currentY}),this.threshold){Math.sqrt(Math.pow(this.pointCoords[this.pointCoords.length-1].y-this.pointCoords[0].y,2)+Math.pow(this.pointCoords[this.pointCoords.length-1].x-this.pointCoords[0].x,2))>this.threshold&&(this.thresholdReached||(this.thresholdReached=!0))}this.ctx&&(this.ctx.lineCap="round",this.ctx.lineWidth=this.lineWidth,this.ctx.strokeStyle=this.color),this.drawLine({color:this.color,width:this.lineWidth,points:this.pointCoords})}}}}export{i as Paintable};
